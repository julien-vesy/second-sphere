---
const navItems = [
  { id: 'accueil', label: 'Accueil', href: '/' },
  { id: 'prestations', label: 'Mes prestations', href: '/prestations' },
  { id: 'realisations', label: 'Mes réalisations', href: '/mes-realisations' },
  { id: 'devis', label: 'Demander un devis', href: '/devis' },
  { id: 'apropos', label: 'À propos', href: '/about' },
]
---

<nav class="bg-white shadow-md sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <a href="/" class="flex items-center space-x-2">
        <img
          id="fixMyCard"
          src="https://kqedvhcdsrldkhpavxgx.supabase.co/storage/v1/object/public/storagetestnet/fix-my-card.jpg"
          alt="Logo"
          fetchpriority="high"
          width="48"
          height="48"
          class="h-12 w-auto"
        />
        <span class="text-xl text-blue-600">Fix My Card</span>
      </a>

      <!-- Desktop nav -->
      <div class="hidden md:flex space-x-8">
        {
          navItems.map((item) => (
            <a
              href={item.href}
              class="transition-colors text-gray-700 hover:text-blue-600"
            >
              {item.label}
            </a>
          ))
        }
      </div>

      <!-- Mobile button -->
      <button id="mobile-toggle" class="md:hidden">
        <svg id="icon-menu" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6"
          ><path
            stroke="currentColor"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"></path></svg
        >
        <svg
          id="icon-close"
          xmlns="http://www.w3.org/2000/svg"
          class="w-6 h-6 hidden"
          ><path stroke="currentColor" stroke-width="2" d="M6 6l12 12M6 18L18 6"
          ></path></svg
        >
      </button>
    </div>

    <!-- Mobile menu -->
    <div id="mobile-menu" class="md:hidden pb-4 space-y-2 hidden">
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class="block w-full text-left px-4 py-2 transition-colors text-gray-700 hover:bg-gray-50"
          >
            {item.label}
          </a>
        ))
      }
    </div>
  </div>
</nav>

<script>
  // Delegation + mises à jour de références pour fonctionner correctement avec ClientRouter
  ;(function () {
    let refs = {}
    let delegatedAttached = false

    function updateRefs() {
      refs.toggle = document.getElementById('mobile-toggle')
      refs.mobileMenu = document.getElementById('mobile-menu')
      refs.iconMenu = document.getElementById('icon-menu')
      refs.iconClose = document.getElementById('icon-close')
    }

    // toggleState: true => menu ouvert, false => fermé
    function setMenuOpen(open) {
      if (!refs.mobileMenu || !refs.iconMenu || !refs.iconClose) return
      refs.mobileMenu.classList.toggle('hidden', !open)
      refs.iconMenu.classList.toggle('hidden', open)
      refs.iconClose.classList.toggle('hidden', !open)
    }

    function handleDocumentClick(e) {
      const clickedToggle =
        e.target.closest && e.target.closest('#mobile-toggle')
      const clickedMobileLink =
        e.target.closest && e.target.closest('#mobile-menu a')

      // récupérer refs à la demande (elles peuvent changer après swap)
      updateRefs()

      if (clickedToggle) {
        // toggle menu
        const isHidden = refs.mobileMenu
          ? refs.mobileMenu.classList.contains('hidden')
          : true
        setMenuOpen(isHidden)
        return
      }

      if (clickedMobileLink) {
        // fermer après clic sur lien mobile
        setMenuOpen(false)
        // laisser la <a> faire la navigation normale
      }
    }

    function init() {
      // initial refs + attach delegation une seule fois
      updateRefs()
      if (!delegatedAttached) {
        document.addEventListener('click', handleDocumentClick)
        delegatedAttached = true
      }
      // s'assurer que l'état initial est fermé
      setMenuOpen(false)
    }

    // init au premier chargement
    init()

    // ré-updater les refs après chaque transition SPA
    window.addEventListener('astro:after-swap', () => {
      // give a tiny tick in case DOM isn't fully swapped instantly
      requestAnimationFrame(() => {
        updateRefs()
        // fermer menu après swap pour éviter états incohérents
        setMenuOpen(false)
      })
    })
  })()
</script>
