---
import { Image, getImage } from 'astro:assets'
import ImageCarrousel from './image-carrousel.tsx'
import Flagadoss from '../../assets/illustrations/realisations/flagadoss.jpg'
import Rayquaza from '../../assets/illustrations/realisations/rayquaza.jpg'
import Drac from '../../assets/illustrations/realisations/dracaufeu.jpg'
import Alakazam from '../../assets/illustrations/realisations/alakazam.jpg'
import Dracolosse from '../../assets/illustrations/realisations/dracolosse.jpg'
import Draco from '../../assets/illustrations/realisations/draco.png'
import Lugia from '../../assets/illustrations/realisations/lugia.png'
import Latios from '../../assets/illustrations/realisations/latios.png'
import Rayquaza2 from '../../assets/illustrations/realisations/rayquaza_2.png'
import MinidracoBlue from '../../assets/illustrations/minidraco_blue.png'
import DracoBlue from '../../assets/illustrations/draco_blue.png'
import DracolosseBlue from '../../assets/illustrations/dracoloss_blue.png'

const loadCarouselImages = async (
  folderName: string,
  optimizedIllustrationSrc: string
) => {
  const carouselImages = []

  carouselImages.push(optimizedIllustrationSrc)

  const images = import.meta.glob(
    '../../assets/illustrations/realisations/carrousel/**/*.{jpg,jpeg,png}'
  )

  for (const path in images) {
    if (path.includes(`/carrousel/${folderName}/`)) {
      const image = await images[path]()
      const optimizedImage = await getImage({
        src: (image as any).default,
        format: 'webp',
        quality: 80,
        width: 768,
      })
      carouselImages.push(optimizedImage.src)
    }
  }

  return carouselImages
}

const projects = [
  {
    title: 'Flagadoss - Southern Islands',
    description: 'Nettoyage professionnel',
    service: MinidracoBlue,
    image: Flagadoss,
    carouselFolder: 'flagadoss',
    before: 'État: présence de saleté, présence de micro rayures',
  },
  {
    title: 'Rayquaza ex - Fantômes Holon',
    description: 'Restauration totale',
    service: DracolosseBlue,
    image: Rayquaza,
    carouselFolder: 'rayquaza',
    before:
      'État: présence de saletés, présence de micro rayure, pliures importantes',
  },
  {
    title: 'Dracaufeu Radieux stamp - Zénith Suprême',
    description: 'Correction d’un endommagement précis',
    service: DracoBlue,
    image: Drac,
    carouselFolder: 'dracaufeu',
    before: 'État: présence d’une tranche relevée',
  },
  {
    title: 'Alakazam star ex - Gardiens de Cristal',
    description: 'Correction d’un endommagement précis',
    service: DracoBlue,
    image: Alakazam,
    carouselFolder: 'alakazam',
    before: 'État: pliure sur la partie holographique',
  },
  {
    title: 'Dracolosse V - Évolution Céleste',
    service: DracolosseBlue,
    image: Dracolosse,
    carouselFolder: 'dracolosse',
    description: 'Restauration totale',
    before: 'État: Pliure importante, enfoncements',
  },
  {
    title: 'Erika’s Dragonair - Gym Heroes',
    service: DracolosseBlue,
    image: Draco,
    carouselFolder: 'draco',
    description: 'Restauration totale',
    before: 'État: Traces de stylo rose, pliures importantes, enfoncements',
  },
  {
    title: 'Lugia Légende - HeartGold SoulSilver',
    service: DracoBlue,
    image: Lugia,
    carouselFolder: 'lugia',
    description: 'Correction d’un endommagement précis',
    before: 'État: Correction d’un enfoncement',
  },
  {
    title: 'Latios ex - Glaciation Plasma',
    service: DracoBlue,
    image: Latios,
    carouselFolder: 'latios',
    description: 'Correction d’un endommagement précis',
    before: 'État: Correction d’une pliure',
  },
  {
    title: 'Rayquaza C Niv.X - Vainqueurs Suprêmes',
    service: DracolosseBlue,
    image: Rayquaza2,
    carouselFolder: 'rayquaza_2',
    description: 'Restauration totale',
    before: 'État: Pliure importante, enfoncements',
  },
]

const projectsWithCarousel = await Promise.all(
  projects.map(async (project) => {
    const optimizedIllustration = await getImage({
      src: project.image,
      format: 'webp',
      quality: 80,
      width: 256,
    })

    const optimizedIllustrationCarrousel = await getImage({
      src: project.image,
      format: 'webp',
      quality: 80,
      width: 768,
    })

    return {
      ...project,
      optimizedImage: optimizedIllustration.src,
      carouselImages: await loadCarouselImages(
        project.carouselFolder,
        optimizedIllustrationCarrousel.src
      ),
    }
  })
)

const carouselData = projectsWithCarousel.map((p) => p.carouselImages)
---

<div class="py-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-12">
      <h1 class="text-5xl mb-4 text-gray-900">Mes réalisations</h1>
      <p class="text-xl text-gray-600 max-w-3xl mx-auto">
        Découvrez nos restaurations de cartes Pokémon avant et après
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16">
      {
        projectsWithCarousel.map((project, index) => (
          <div
            data-clickable-image
            class="bg-card text-card-foreground flex flex-col rounded-xl border overflow-hidden hover:shadow-xl transition-shadow cursor-pointer group"
          >
            <div class="relative h-64 overflow-hidden bg-gray-100">
              <img
                src={project.optimizedImage}
                alt={project.title}
                loading={index < 3 ? 'eager' : 'lazy'}
                fetchpriority={index < 3 ? 'high' : undefined}
                class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
              />
              <div class="absolute top-4 right-4">
                <span class="inline-flex items-center justify-center rounded-full w-14 h-14 bg-white shadow-lg">
                  <Image
                    src={project.service}
                    width={40}
                    height={40}
                    alt="Icône formule"
                    loading="lazy"
                  />
                </span>
              </div>
            </div>
            <div class="px-6 py-6 flex-1 flex flex-col">
              <h3 class="text-xl font-semibold mb-2 text-gray-900">
                {project.title}
              </h3>
              <p class="text-sm text-gray-600 mb-4">{project.description}</p>
              <div class="mt-auto space-y-2 text-sm">
                <div class="flex items-start gap-2">
                  <span class="text-gray-700">{project.before}</span>
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </div>
  <ImageCarrousel carouselData={carouselData} client:idle />
</div>
